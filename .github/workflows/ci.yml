name: CI Pipeline

on:
  workflow_call:
    inputs:
      run_publish:
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  lint:
    runs-on: ubuntu-latest
    container:
      image: python:3.12-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install build tools
        run: apt-get update && apt-get install -y gcc build-essential
      - name: Install Poetry
        run: pip install poetry
      - name: Install dependencies
        run: poetry install --with dev
      - name: Lint with flake8 and pylint
        run: |
          poetry run flake8 ccsds
          poetry run pylint ccsds

  test:
    runs-on: ubuntu-latest
    container:
      image: python:3.12-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install build tools
        run: apt-get update && apt-get install -y gcc build-essential
      - name: Install Poetry
        run: pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: Run tests
        run: poetry run pytest

  publish:
    if: ${{ inputs.run_publish }}
    needs: [lint, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Publish PyPi package
        uses: code-specialist/pypi-poetry-publish@v1.2
        with:
          ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_REGISTRY_PASSWORD: ${{ secrets.PYPI_TOKEN }}
          PUBLISH_REGISTRY: "https://test.pypi.org/legacy/"
          BRANCH: main
